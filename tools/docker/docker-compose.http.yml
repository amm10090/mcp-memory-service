# Docker Compose configuration for HTTP/API mode
# Usage: docker-compose -f docker-compose.http.yml up -d

services:
  mcp-memory-service:
    build:
      context: ../..
      dockerfile: tools/docker/Dockerfile
    ports:
      - '${HTTP_PORT:-8081}:8001' # Map to different port if needed
    volumes:
      # Single data directory for all storage
      - ./data:/app/data

      # Model cache (prevents re-downloading models on each restart)
      # Uncomment the following line to persist Hugging Face models
      # - ${HOME}/.cache/huggingface:/root/.cache/huggingface

      # Optional: mount local config
      # - ./config:/app/config:ro
    environment:
      # Mode selection
      - MCP_MODE=http

      # Storage configuration
      - MCP_MEMORY_STORAGE_BACKEND=cloudflare
      - CLOUDFLARE_API_TOKEN=8hsVk6pEey-6qEy-DPJowSlYMSk0-pq_ARNrcGnk
      - CLOUDFLARE_ACCOUNT_ID=198ba79e8177dcc4ca65de919cbfc722
      - CLOUDFLARE_D1_DATABASE_ID=2bb9ef18-9e17-4356-abe8-fadb3be4df59
      - CLOUDFLARE_VECTORIZE_INDEX=your-index-name
      # HTTP configuration
      - MCP_HTTP_PORT=8001
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_ENABLED=true
      # Authentication configuration
      - MCP_OAUTH_ENABLED=flease
      - MCP_OAUTH_ISSUER=http://localhost:8081 # Match server port
      - MCP_HTTPS_ENABLED=false # Optional for localhost
      - MCP_OAUTH_ACCESS_TOKEN_EXPIRE_MINUTES=60
      - MCP_OAUTH_AUTHORIZATION_CODE_EXPIRE_MINUTES=10

      # Service Discovery
      - MCP_MDNS_ENABLED=true
      - MCP_MDNS_SERVICE_NAME=memory
      # Optional: HTTPS configuration
      # - MCP_HTTPS_ENABLED=true
      # - MCP_HTTPS_PORT=8443
      # - MCP_SSL_CERT_FILE=/app/certs/cert.pem
      # - MCP_SSL_KEY_FILE=/app/certs/key.pem

      # Performance tuning
      - LOG_LEVEL=DEBUG
      - MAX_RESULTS_PER_QUERY=10
      - SIMILARITY_THRESHOLD=0.7

      # Python configuration
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app/src

      # Offline mode (uncomment if models are pre-cached and network is restricted)
      # - HF_HUB_OFFLINE=1
      # - TRANSFORMERS_OFFLINE=1

    # Use the unified entrypoint
    entrypoint: ['/usr/local/bin/docker-entrypoint-unified.sh']

    restart: unless-stopped

    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8081/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
