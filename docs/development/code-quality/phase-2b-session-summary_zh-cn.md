# Phase 2B: 会话摘要质量改进（摘要）

## 目标
- 提升会话结束时生成的摘要质量，减少冗余与偏离主题。

## 问题现状
- 摘要易受自匹配高分干扰，导致“看似高质量”但信息重复。
- 长会话中重要段落被压缩或丢失。

## 改进方案
1) **质量感知抽取**：使用质量分和访问频次选择候选片段，再做压缩。
2) **多步摘要**：分段摘要 → 合并 → 质量加权重排。
3) **长度控制**：默认 150-300 词；提供 `MCP_SESSION_SUMMARY_MAX_TOKENS` 配置。
4) **元数据保留**：保留时间戳、来源记忆 ID，便于追溯。

## 实施要点
- SessionEnd Hook：触发 `/api/quality/memories/{hash}/evaluate` 后再汇总，允许异步。
- 重排公式示例：`0.6 * relevance + 0.4 * quality_score`。
- 失败回退：若质量分缺失，按语义相似度排序。

## 配置
```bash
export MCP_SESSION_SUMMARY_MAX_TOKENS=300
export MCP_SESSION_SUMMARY_MIN_QUALITY=0.5   # 低于则降权或丢弃
```

## 验收标准
- P95 生成时延 < 1.5s（本地 SLM）。
- 用户人工评审：相关性/简洁性 ≥ 0.7（5 分制换算）。
- 重复率下降：与原文重复 n-gram < 15%。

## 后续
- 与 Phase 3 LLM 评审联动，支持“高价值会话”深度摘要。
- 在控制台提供“查看摘要来源”入口以提升可解释性。
